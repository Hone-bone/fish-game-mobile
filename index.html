<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>金魚すくいゲーム</title>
    <link rel="stylesheet" href="css/style.css" />
    <!-- PWA関連 -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#5ea6df" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <link rel="apple-touch-icon" href="assets/app-icon.png" />
    <!-- アニメーションライブラリ -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <!-- サウンドライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <!-- Hammer.js タッチ操作用 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>

    <script>
      // 最初に読み込むスクリプト
      window.onload = function () {
        console.log("Window onload");
        const startButton = document.getElementById("start-button");
        if (startButton) {
          startButton.onclick = function () {
            console.log("インラインボタンクリック");
          };
        }
      };
    </script>
  </head>
  <body>
    <!-- 端末の向き通知 -->
    <div id="orientation-message">
      <p>このゲームは縦向きで遊ぶのがおすすめです</p>
      <div class="rotate-icon">📱</div>
      <p>端末を縦向きにしてください</p>
    </div>

    <div class="game-container">
      <div class="game-header">
        <div class="score-container">スコア: <span id="score">0</span></div>
        <div class="timer-container">
          残り時間: <span id="timer">60</span>秒
        </div>
      </div>

      <div class="game-area">
        <canvas id="game-canvas"></canvas>
        <div id="poi-container">
          <img id="poi" src="assets/poi.svg" alt="ポイ" />
        </div>
        <div id="splash-container"></div>
      </div>

      <div class="game-controls">
        <button id="start-button">ゲームスタート</button>
        <div class="instructions">
          <h3>遊び方</h3>
          <p>
            ポイを使って金魚をすくってください！制限時間内にできるだけ多くの金魚をすくいましょう。
          </p>
          <p>
            金魚の種類によってスコアが異なります。レアな金魚を狙いましょう！
          </p>
        </div>
      </div>

      <div id="game-over" class="hidden">
        <div class="game-over-content animate__animated animate__zoomIn">
          <h2>ゲーム終了!</h2>
          <p>最終スコア: <span id="final-score">0</span></p>
          <button id="restart-button">もう一度プレイ</button>
          <button id="share-button">結果をシェア</button>
        </div>
      </div>
    </div>

    <script>
      // シンプルで基本的なゲーム機能を実装
      document.addEventListener("DOMContentLoaded", function () {
        // ゲーム要素
        const canvas = document.getElementById("game-canvas");
        const ctx = canvas.getContext("2d");
        const startButton = document.getElementById("start-button");
        const restartButton = document.getElementById("restart-button");
        const shareButton = document.getElementById("share-button");
        const timerElement = document.getElementById("timer");
        const scoreElement = document.getElementById("score");
        const gameOverScreen = document.getElementById("game-over");
        const finalScoreElement = document.getElementById("final-score");
        const poiContainer = document.getElementById("poi-container");
        const poiElement = document.getElementById("poi");
        const splashContainer = document.getElementById("splash-container");

        // ゲーム状態
        let gameState = {
          isPlaying: false,
          score: 0,
          timeRemaining: 60,
          timeInterval: null,
          fish: [],
          lastTouchX: 0,
          lastTouchY: 0,
          poiCatchAttempts: 0,
          poiBroken: false,
        };

        // キャンバスサイズの設定
        function resizeCanvas() {
          const gameArea = document.querySelector(".game-area");
          canvas.width = gameArea.offsetWidth;
          canvas.height = gameArea.offsetHeight;

          // ゲーム内容の再描画
          if (gameState.isPlaying) {
            drawWaterPattern();
            drawFish();
          }
        }

        // ゲーム開始関数
        function startGame() {
          console.log("ゲーム開始");
          if (gameState.isPlaying) return;

          // ゲーム状態のリセット
          gameState.isPlaying = true;
          gameState.score = 0;
          gameState.timeRemaining = 60;
          gameState.poiCatchAttempts = 0;
          gameState.poiBroken = false;
          gameState.fish = [];

          // 表示の更新
          scoreElement.textContent = "0";
          timerElement.textContent = "60";

          // ゲームオーバー画面を非表示
          gameOverScreen.classList.add("hidden");

          // スタートボタンを非表示
          startButton.style.display = "none";
          document.querySelector(".instructions").style.display = "none";

          // 初期魚を生成
          for (let i = 0; i < 5; i++) {
            createFish();
          }

          // タイマーの開始
          gameState.timeInterval = setInterval(updateTimer, 1000);

          // ゲームループの開始
          requestAnimationFrame(gameLoop);
        }

        // タイマー更新
        function updateTimer() {
          gameState.timeRemaining--;
          timerElement.textContent = gameState.timeRemaining;

          if (gameState.timeRemaining <= 0) {
            endGame();
          }
        }

        // ゲーム終了
        function endGame() {
          gameState.isPlaying = false;
          clearInterval(gameState.timeInterval);

          // 最終スコアの表示
          finalScoreElement.textContent = gameState.score;

          // ゲームオーバー画面の表示
          gameOverScreen.classList.remove("hidden");

          // スタートボタンを再表示
          startButton.style.display = "block";
          document.querySelector(".instructions").style.display = "block";
        }

        // 魚の生成
        function createFish() {
          const fishColors = ["red", "gold", "blue", "black"];
          const fishSizes = [30, 25, 20, 35];
          const fishPoints = [10, 20, 30, 50];

          const randomIndex = Math.floor(Math.random() * fishColors.length);

          // 魚の開始位置
          const startFromSide = Math.random() > 0.5;
          let x, y, directionX, directionY;

          if (startFromSide) {
            x = Math.random() > 0.5 ? 0 : canvas.width;
            y = Math.random() * canvas.height;
            directionX = x === 0 ? 1 : -1;
            directionY = Math.random() * 2 - 1;
          } else {
            x = Math.random() * canvas.width;
            y = Math.random() > 0.5 ? 0 : canvas.height;
            directionX = Math.random() * 2 - 1;
            directionY = y === 0 ? 1 : -1;
          }

          // 魚オブジェクト
          const fish = {
            x: x,
            y: y,
            size: fishSizes[randomIndex],
            color: fishColors[randomIndex],
            points: fishPoints[randomIndex],
            directionX: directionX,
            directionY: directionY,
            rotation: Math.atan2(directionY, directionX),
          };

          gameState.fish.push(fish);
        }

        // 魚の更新
        function updateFish() {
          gameState.fish.forEach((fish) => {
            // 魚の移動
            fish.x += fish.directionX * 2;
            fish.y += fish.directionY * 2;

            // キャンバスの端に到達したら向きを変える
            if (fish.x <= 0 || fish.x >= canvas.width) {
              fish.directionX *= -1;
            }
            if (fish.y <= 0 || fish.y >= canvas.height) {
              fish.directionY *= -1;
            }

            // 回転角度の更新
            fish.rotation = Math.atan2(fish.directionY, fish.directionX);
          });

          // 一定の確率で新しい魚を追加
          if (Math.random() < 0.02 && gameState.fish.length < 15) {
            createFish();
          }
        }

        // 魚の描画
        function drawFish() {
          gameState.fish.forEach((fish) => {
            ctx.save();
            ctx.translate(fish.x, fish.y);
            ctx.rotate(fish.rotation);

            // 魚の体
            ctx.fillStyle = fish.color;
            ctx.beginPath();
            ctx.ellipse(0, 0, fish.size / 2, fish.size / 4, 0, 0, Math.PI * 2);
            ctx.fill();

            // 尾びれ
            ctx.beginPath();
            ctx.moveTo(fish.size / 2, 0);
            ctx.lineTo(fish.size, fish.size / 4);
            ctx.lineTo(fish.size, -fish.size / 4);
            ctx.closePath();
            ctx.fill();

            ctx.restore();
          });
        }

        // 水の背景描画
        function drawWaterPattern() {
          // キャンバスをクリア
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // 青い背景
          ctx.fillStyle = "#5ea6df";
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // 水の波紋
          ctx.save();
          ctx.globalAlpha = 0.1;
          for (let i = 0; i < 5; i++) {
            ctx.beginPath();
            ctx.arc(
              canvas.width / 2,
              canvas.height / 2,
              50 + i * 40,
              0,
              Math.PI * 2
            );
            ctx.strokeStyle = "#ffffff";
            ctx.lineWidth = 5;
            ctx.stroke();
          }
          ctx.restore();
        }

        // ポイの位置を更新
        function updatePoiPosition(x, y) {
          poiContainer.style.left = `${x - 40}px`;
          poiContainer.style.top = `${y - 40}px`;
          gameState.lastTouchX = x;
          gameState.lastTouchY = y;
        }

        // 水しぶきエフェクト
        function createSplash(x, y) {
          const splash = document.createElement("div");
          splash.className = "splash";
          splash.style.left = `${x}px`;
          splash.style.top = `${y}px`;

          splashContainer.appendChild(splash);

          setTimeout(() => {
            splash.remove();
          }, 600);
        }

        // 魚をすくう
        function catchFish(x, y) {
          if (gameState.poiBroken) return;

          // ポイの使用回数を増やす
          gameState.poiCatchAttempts++;

          // ポイが壊れたかチェック
          if (gameState.poiCatchAttempts >= 5) {
            gameState.poiBroken = true;
            setTimeout(() => {
              gameState.poiBroken = false;
              gameState.poiCatchAttempts = 0;
            }, 3000);
            return;
          }

          // 魚を捕まえたかチェック
          gameState.fish.forEach((fish, index) => {
            const distance = Math.sqrt(
              Math.pow(fish.x - x, 2) + Math.pow(fish.y - y, 2)
            );

            if (distance < 40) {
              // スコア加算
              gameState.score += fish.points;
              scoreElement.textContent = gameState.score;

              // 魚を削除
              gameState.fish.splice(index, 1);

              // 新しい魚を追加
              createFish();
            }
          });
        }

        // ゲームループ
        function gameLoop() {
          if (!gameState.isPlaying) return;

          // 背景と魚の描画
          drawWaterPattern();
          updateFish();
          drawFish();

          // 次のフレーム
          requestAnimationFrame(gameLoop);
        }

        // マウスとタッチのイベント
        canvas.addEventListener("mousedown", (e) => {
          if (!gameState.isPlaying) return;
          const rect = canvas.getBoundingClientRect();
          updatePoiPosition(e.clientX - rect.left, e.clientY - rect.top);
          poiContainer.style.display = "block";
        });

        canvas.addEventListener("mousemove", (e) => {
          if (!e.buttons || !gameState.isPlaying) return;
          const rect = canvas.getBoundingClientRect();
          updatePoiPosition(e.clientX - rect.left, e.clientY - rect.top);
        });

        canvas.addEventListener("mouseup", (e) => {
          if (!gameState.isPlaying) return;
          const rect = canvas.getBoundingClientRect();
          catchFish(e.clientX - rect.left, e.clientY - rect.top);
          poiContainer.style.display = "none";
          createSplash(e.clientX - rect.left, e.clientY - rect.top);
        });

        canvas.addEventListener("touchstart", (e) => {
          if (!gameState.isPlaying) return;
          e.preventDefault();
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          updatePoiPosition(
            touch.clientX - rect.left,
            touch.clientY - rect.top
          );
          poiContainer.style.display = "block";
        });

        canvas.addEventListener("touchmove", (e) => {
          if (!gameState.isPlaying) return;
          e.preventDefault();
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches[0];
          updatePoiPosition(
            touch.clientX - rect.left,
            touch.clientY - rect.top
          );
        });

        canvas.addEventListener("touchend", (e) => {
          if (!gameState.isPlaying) return;
          e.preventDefault();
          catchFish(gameState.lastTouchX, gameState.lastTouchY);
          poiContainer.style.display = "none";
          createSplash(gameState.lastTouchX, gameState.lastTouchY);
        });

        // イベントリスナーの設定
        startButton.addEventListener("click", startGame);
        restartButton.addEventListener("click", startGame);

        // 初期化
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();
        drawWaterPattern();

        console.log("ゲーム初期化完了");
      });
    </script>
  </body>
</html>
